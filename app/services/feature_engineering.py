import pandas as pd
import numpy as np

class FeatureEngineer:
    def transform(self, df: pd.DataFrame) -> pd.DataFrame:
        df = df.copy()
        
        # Extract title from name
        df['Title'] = df['Name'].str.extract(' ([A-Za-z]+)\.', expand=False)
        
        # Family size
        df['FamilySize'] = df['SibSp'] + df['Parch'] + 1
        df['IsAlone'] = (df['FamilySize'] == 1).astype(int)
        
        # Age imputation
        df['Age'] = df['Age'].fillna(df['Age'].median())
        
        # Fare normalization
        df['Fare'] = df['Fare'].fillna(df['Fare'].median())
        df['Fare'] = np.log1p(df['Fare'])

        # Fill missing Embarked with the mode
        mode_embarked = df['Embarked'].mode()[0]
        df['Embarked'] = df['Embarked'].fillna(mode_embarked)

        # One-hot encode categorical features
        categorical_cols = ['Sex', 'Embarked', 'Title']
        df = pd.get_dummies(df, columns=categorical_cols, drop_first=True, dummy_na=False) # drop_first to avoid multicollinearity

        # Clean up column names generated by get_dummies (optional but good practice)
        df.columns = ["".join (c if c.isalnum() else "_" for c in str(x)) for x in df.columns]

        return df
